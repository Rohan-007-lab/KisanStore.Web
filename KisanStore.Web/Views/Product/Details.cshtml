@model KisanStore.Web.Models.Product
@{
    ViewData["Title"] = Model.ProductName;
}

<div class="container my-5">
    <div class="row">
        <div class="col-md-6">
            <img src="@(Model.ImageUrl ?? "/images/placeholder.jpg")" class="img-fluid rounded shadow" alt="@Model.ProductName">
        </div>
        <div class="col-md-6">
            <span class="badge bg-info text-dark mb-2">@Model.Category?.CategoryName</span>
            <h2>@Model.ProductName</h2>
            <p class="text-muted">By @Model.Manufacturer</p>
            
            <div class="my-3">
                @if (Model.DiscountPrice.HasValue)
                {
                    <h3 class="price d-inline">₹@Model.DiscountPrice</h3>
                    <span class="old-price h5 ms-3">₹@Model.Price</span>
                    <span class="badge bg-danger ms-2">
                        @Math.Round((decimal)(Model.Price - Model.DiscountPrice) / Model.Price * 100)% OFF
                    </span>
                }
                else
                {
                    <h3 class="price">₹@Model.Price</h3>
                }
                <p class="text-muted">per @Model.Unit</p>
            </div>

            @if (Model.StockQuantity > 0)
            {
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> In Stock (@Model.StockQuantity available)
                </div>
                
                <form id="addToCartForm">
                    <div class="input-group mb-3" style="max-width: 200px;">
                        <button class="btn btn-outline-secondary" type="button" onclick="changeQty(-1)">-</button>
                        <input type="number" id="quantity" class="form-control text-center" value="1" min="1" max="@Model.StockQuantity">
                        <button class="btn btn-outline-secondary" type="button" onclick="changeQty(1)">+</button>
                    </div>
                    <button type="button" onclick="addToCart(@Model.ProductId)" class="btn btn-primary btn-lg">
                        <i class="fas fa-shopping-cart"></i> Add to Cart
                    </button>
                </form>
            }
            else
            {
                <div class="alert alert-danger">
                    <i class="fas fa-times-circle"></i> Out of Stock
                </div>
            }

            <hr class="my-4">
            
            <h5>Product Description</h5>
            <p>@Model.Description</p>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function changeQty(delta) {
            const input = document.getElementById('quantity');
            const newVal = parseInt(input.value) + delta;
            if (newVal >= 1 && newVal <= parseInt(input.max)) {
                input.value = newVal;
            }
        }

        function addToCart(productId) {
            const quantity = document.getElementById('quantity').value;
            
            fetch('/Cart/AddToCart', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `productId=${productId}&quantity=${quantity}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Product added to cart!');
                    window.location.href = '/Cart';
                } else {
                    alert(data.message);
                    if (data.message.includes('login')) {
                        window.location.href = '/Account/Login';
                    }
                }
            });
        }
    </script>
}